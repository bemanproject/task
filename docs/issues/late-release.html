<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<style>
  ins {background-color:#A0FFA0}
  del {background-color:#FFA0A0}
</style>
<title>task's coroutine frame may be released late</title>
</head>
<body>
<h3><code>task</code>'s coroutine frame may be released late</h3>
<p><b>Section:</b> 33.13.6 <a href="https://wg21.link/exec.task">[exec.task]</a></p>
<p><b>Submitter:</b> Dietmar K&uuml;hl</p>
<p><b>Discussion:</b></p>
<p>
The specification of <code>task</code> doesn't spell out when the
coroutine frame is destroyed (i.e., when <code>handle.destroy()</code>
is called). As a result the lifetime of arguments passed to the
coroutine and/or of local variables in the coroutine body may be
longer than expected.
</p>
<p>
The intention is that the coroutine frame is destroyed before any
of the completion functions is called. One implication of that
requirement is that the result and error objects can't be stored
in the <code>promise_type</code> when the completion function is
called although the exposition-only members <code><i>result</i></code>
and <code><i>errors</i></code> imply exactly that. Instead the data
needs to be stored in the operation state object or it needs to be
moved to a different place before calling <code>destroy()</code>.
</p>
<p>
The proposed resolution is to add a paragraph to the specification
of <code>promise_type</code> in <a href="https://wg21.link/task.promise">[task.promise]</a> that spells
out that the coroutine frame is destroyed before any of the completion
functions is called. To actually do that the exposition-only members
<code><i>result</i></code> and <code><i>errors</i></code> can't
remain as members of the <code>promise_type</code>. While writing
the relevant change it turned out that <code><i>errors</i></code>
is a <code>variant</code> which only ever stores an
<code>exception_ptr</code> (the other potential errors are immediately
reported via the awaiter return from <code>yield_value</code>).
Thus, the <code>variant</code> can be replaced with an
<code>exception_ptr</code>.
</p>
<p><b>Proposed resolution:</b></p>
<p>
In <a href="https://wg21.link/task.state">[task.state]</a>, add
exposition-only data members <code><i>result</i></code> and
<code><i>error</i></code> to the exposition-only  class
<code><i>state</i></code>:
<blockquote>
<pre>
namespace std::execution {
  template&lt;class T, class Environment&gt;
  template&lt;receiver Rcvr&gt;
  class task&lt;T, Environment&gt;::<i>state</i> {           // <i>exposition only</i>
  ...
  Environment               <i>environment</i>;   // <i>exposition only</i>
  <ins>optional&lt;T&gt;               <i>result</i>;        // <i>exposition only; present only if</i> is_void_v&lt;T&gt; <i>is</i> false</ins>
  <ins>exception_ptr             <i>error</i>;         // <i>exposition-only</i></ins>
};
}
</pre>
</blockquote>
</p>
<p>
Remove the exposition-only data members
<code><i>result</i></code> and <code><i>errors</i></code> from
the class <code>promise_type</code> in
<a href="https://wg21.link/task.promise">[task.promise]</a>:
<blockquote>
<pre>
namespace std::execution {
  template&lt;class T, class Environment&gt;
  class task&lt;T, Environment&gt;::promise_type {
  ...
  stop_token_type   <i>token</i>;  // <i>exposition only</i>
  <del>optional&lt;T&gt;       <i>result</i>; // <i>exposition only; present only if</i> is_void_v&lt;T&gt; <i>is</i> false</del>
  <del><i>error-variant</i>     <i>errors</i>; // <i>exposition only</i></del>
};
}
</pre>
</blockquote>
</p>
<p>
Add the following paragraph to <a href="https://wg21.link/task.promise">[task.promise]</a> after paragraph 2:
<blockquote>
<p><ins>
-3- The coroutine frame is destroyed (using
<code><i>STATE</i>(*this).<i>handle</i>.destroy()</code>) before
any of the completion functions is called.
</ins>
</p>
</blockquote>
</p>
</body>
</html>
